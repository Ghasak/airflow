# AIRFLOW WITH DOCKER COMPOSE

Here is a **`Makefile`** tailored to your **Airflow setup using Docker
Compose**. This `Makefile` will include all relevant commands you need to
**initialize, manage, and debug Airflow**, with helpful docstrings and
**colored help** for easier usage.

---

### **Makefile**

Save this as `Makefile` in the root directory of your project:

```Makefile
# Makefile for managing Airflow Docker Compose setup

# Colors for help message
RED=\033[31m
GREEN=\033[32m
YELLOW=\033[33m
RESET=\033[0m

# Default target
.PHONY: help

help:  ## Show this help message
	@echo -e "$(GREEN)Available Commands:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-15s$(RESET) %s\n", $$1, $$2}'

up: ## Start all services in detached mode
	docker compose up -d

down: ## Stop and remove all services, volumes, and images
	docker compose down --volumes --rmi all

restart: ## Restart all Airflow services
	docker compose restart

init: ## Initialize the Airflow database (run only once or after reset)
	docker compose up airflow-init

logs: ## Tail logs from all running containers
	docker compose logs -f

ps: ## List running containers
	docker ps

bash-webserver: ## Open a bash shell in the Airflow webserver container
	docker exec -it $(shell docker ps -qf "name=airflow-webserver") /bin/bash

bash-scheduler: ## Open a bash shell in the Airflow scheduler container
	docker exec -it $(shell docker ps -qf "name=airflow-scheduler") /bin/bash

copy-config: ## Copy airflow.cfg from container to local config directory
	docker cp $(shell docker ps -qf "name=airflow-webserver"):/opt/airflow/airflow.cfg ./config/airflow.cfg

build: ## Build the Docker images (required after modifying Dockerfile)
	docker compose build

prune: ## Clean up unused Docker resources (dangling images, stopped containers)
	docker system prune -f

upgrade: ## Upgrade Airflow database schema after Airflow version update
	docker compose run airflow-worker airflow db upgrade

tail-log-file: ## Tail the output_log.txt from the logs directory
	tail -f ./logs/output_log.txt

clean: ## Remove DAG logs and output files
	rm -rf ./logs/* ./config/airflow.cfg

```

---

### **Explanation and How to Use Each Command**

Hereâ€™s a quick reference for each target in the `Makefile`:

- **`help`**:

  ```bash
  make help
  ```

  **When to use**: Displays a list of available commands with descriptions in **colored output** to improve readability.

- **`up`**:

  ```bash
  make up
  ```

  **When to use**: Starts all services (webserver, scheduler, database, Redis) in detached mode.

- **`down`**:

  ```bash
  make down
  ```

  **When to use**: Stops and removes all services, including volumes and images, to start fresh.

- **`restart`**:

  ```bash
  make restart
  ```

  **When to use**: Restarts the Airflow services if you make changes to configurations or the environment.

- **`init`**:

  ```bash
  make init
  ```

  **When to use**: Initializes the Airflow database (only required the first time or after resetting the database).

- **`logs`**:

  ```bash
  make logs
  ```

  **When to use**: Tail the logs from all containers to debug any issues.

- **`ps`**:

  ```bash
  make ps
  ```

  **When to use**: List all running containers and check their status.

- **`bash-webserver` / `bash-scheduler`**:

  ```bash
  make bash-webserver
  make bash-scheduler
  ```

  **When to use**: Open a shell inside the webserver or scheduler container for debugging or manual interventions.

- **`copy-config`**:

  ```bash
  make copy-config
  ```

  **When to use**: Copies the `airflow.cfg` from the container to your local machine for easy modification.

- **`build`**:

  ```bash
  make build
  ```

  **When to use**: Rebuild Docker images if you modify the `Dockerfile` or dependencies.

- **`prune`**:

  ```bash
  make prune
  ```

  **When to use**: Clean up unused Docker resources to free space.

- **`upgrade`**:

  ```bash
  make upgrade
  ```

  **When to use**: Run database migrations after upgrading Airflow.

- **`tail-log-file`**:

  ```bash
  make tail-log-file
  ```

  **When to use**: Monitor the `output_log.txt` generated by your DAGs in real-time.

- **`clean`**:
  ```bash
  make clean
  ```
  **When to use**: Remove all logs and temporary files to reset the environment.

---

### **How to Use the Makefile**

1. Save the file as **`Makefile`** in your project root.
2. Open a terminal and navigate to your project directory:
   ```bash
   cd /Users/gmbp/Desktop/devCode/pythonHub/airflow_with_docker
   ```
3. Run the commands using:
   ```bash
   make <target>
   ```
   Example:
   ```bash
   make up
   ```

This `Makefile` simplifies Airflow management, providing **helpful
documentation** and automating frequent tasks, such as **starting services,
restarting, and managing configurations**.

